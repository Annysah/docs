---
title: Webhooks
html_title: Webhooks
description: Webhooks augment the data available to certificate templates
---

<Alert severity="info">
  <AlertTitle>Remote Management Required</AlertTitle>
  <div>
    Check out our guide to{' '}
    <Link href="/docs/step-ca/provisioners/#remote-provisioner-management">
    enabling remote management</Link>.
  </div>
</Alert>

Administrators can attach webhooks to provisioners to retrieve additional data that will be available when rendering [certificate templates](/docs/step-ca/templates).


## Webhook Response

The webhook server must include `"allow": true` in the response body or step-ca will refuse to sign the certificate request.

step-ca will augment the template data context with whatever is returned from the webhook server in the `data` field of the response body.
For example, a webhook could send the following json response:
```json
{
  "allow": true,
  "data": {
    "role": "eng"
  }
}
```

A template on the provisioner will then be able to reference the response under the path `.Webhooks.webhook_name`.
If the webhook was named `people`, the role in the webhook response could be accessed in a template under the field `.Webhooks.people.role`.

## Requests

All requests will use the POST method to send a json body to the webhook server containing a `timestamp` field.
Additional data will vary based on the type of the certificate being signed.
Refer to the [webhooks server example repository](https://github.com/smallstep/webhooks) for examples in Go of parsing webhook request bodies for both x509 and SSH certificate requests.

### X509 Request Body

For x509 certificates step-ca will include an `x509CertificateRequest` field that will hold a [json representation of the request](https://pkg.go.dev/go.step.sm/crypto@v0.23.1/x509util#CertificateRequest) using the same schema as [x509 template functions](https://smallstep.com/docs/step-ca/templates/#x509-templates) with a [few extra fields](https://github.com/smallstep/certificates/blob/c169defc73db6ba4b83e1acd5bd31feafb4df050/webhook/types.go#L19-L22).
When used with the [acme provisioner](https://smallstep.com/docs/step-ca/provisioners#acme) and the `device-attest-01` challenge, the request body will also contain the verified device ID in the `attestationData.permanentIdentifier` field.

### SSH Request Body

For ssh certificates step-ca will include an `sshCertificateRequest` field with [data from the request](https://github.com/smallstep/certificates/blob/c169defc73db6ba4b83e1acd5bd31feafb4df050/webhook/types.go#L37).


### Authentication

The webhook server must authenticate step-ca before responding with data.

#### Signature

Every webhook has a unique secret that will be displayed when the webhook is created with `step ca provisioner webhook add`.
step-ca will include a signature of the payload in the X-Smallstep-Signature header.
The webhook ID will also be included in the X-Smallstep-Webhook-ID header to help associate the correct signing secret with the webhook request.
Webhook servers must compute an HMAC with the SHA256 hash function using the webhook signing secret as the key and the request body as the message.
See the [webhook server example repository](https://github.com/smallstep/webhooks) for an example of verifying the signature.

#### Authorization Header

For an additional layer of security, step-ca may be configured to send either a bearer token or a username:password in the Authorization header.

```
step ca provisioner webhook update my_provisioner my_webhook --bearer-token=abc123xyz
```

or for basic authentication:

```
step ca provisioner webhook update my_provisioner my_webhook --basic-auth-username user --basic-auth-password pass
```

#### TLS Client Certificate Authentication

By default step-ca will send the authority's leaf certificate when the webhook server requests a client certificate.
This behavior can be disabled:

```
step ca provisioner webhook update my_webhook --provisioner my_provision --disable-tls-client-auth
```

## Tutorial

1. Initialize a new Certificate Authority with remote management enabled.

```bash
step ca init --remote-management --context webhooks
```

2. Clone the [example webhook repository](https://github.com/smallstep/webhooks).
```bash
git clone git@github.com:smallstep/webhooks.git
cd webhooks
```

3. Generate a certificate for your webhook server.

```bash
step ca certificate localhost webhook.crt webhook.key
```

4. Save the root CA for you authority to the path where the example webhook server expects to find it.
```bash
step ca root > root_ca.crt
```

5. Add a new provisioner. With remote management enabled the default JWK provisioner has a super admin named `step` for managing CA provisioners. If a webhook is added to the default provisioner and fails, it will be impossible to authenticate successfully as the admin user.

```bash
step ca provisioner add my_provisioner --create
```

6. Add a webhook to your provisioner for a webhook server that will be listening on localhost:9443.
```bash
step ca provisioner webhook add my_provisioner people --url 'https://localhost:9443/{{ .Token.sub }}'
```
This command will print out the webhook ID and webhook secret.

7. Update the [webhookIDsToSecrets map](https://github.com/smallstep/webhooks/blob/f6a74c2e30dcb19b15d9903fdb6271a8358d26cd/main.go#L31) in the example webhook's main.go file with the ID and secret printed above.

8. Update the [db map](https://github.com/smallstep/webhooks/blob/f6a74c2e30dcb19b15d9903fdb6271a8358d26cd/main.go#L26) in the example webhook's main.go file with the Common Name you will be issuing test certificates for.

9. Start the webhook server

```bash
go run main.go
```

10. Get a certificate with the provisioner that has a webhook:

```bash
step ca certificate andrew@smallstep.com my.crt my.key --provisioner my_provisioner
```

11. Add a template to the provisioner to incorporate the data returned from the webhook.

```bash
cat <<EOF > prov.tmpl
{
  "subject": {
    "organizationalUnit": {{ toJson .Webhooks.people.role }}
  }
}
EOF
step ca provisioner update my_provisioner --x509-template prov.tmpl
```

12. Inspect the certificate to see that the role returned from the webhook server appears in the OU.
```
step certificate inspect my.crt --format json | jq .subject
```
